<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, onValue } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA7Ui4SXydisrIUpeX32vpqcIDQCsqOLXo",
  authDomain: "saayadonat.firebaseapp.com",
  databaseURL: "https://saayadonat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "saayadonat",
  storageBucket: "saayadonat.firebasestorage.app",
  messagingSenderId: "191838417140",
  appId: "1:191838417140:web:7a41a9b5678e6200f2eea1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let products = [];
let orders = [];
let chart;

window.login = function(){
  if(pass.value==='admin123'){
    document.getElementById('panel').classList.remove('hidden');
  }
}

window.addProduct = function(){
  products.push({
    name:pName.value,
    price:+pPrice.value,
    stock:+pStock.value
  });
  set(ref(db,'products'), products);
}

window.updateStock = function(i,val){
  products[i].stock += val;
  if(products[i].stock < 0) products[i].stock = 0;
  set(ref(db,'products'), products);
}

onValue(ref(db,'products'), snapshot=>{
  products = snapshot.val() || [];
  render();
});

onValue(ref(db,'orders'), snapshot=>{
  orders = Object.values(snapshot.val() || {});
  renderOrders();
  renderChart();
});

function render(){
  let html='';
  products.forEach((p,i)=>{
    html+=`
    <div>
      <b>${p.name}</b>
      <span class="badge">Stok ${p.stock}</span><br>
      Rp ${p.price}<br>
      <button onclick="updateStock(${i},1)">+ Stok</button>
      <button onclick="updateStock(${i},-1)">- Stok</button>
      <hr>
    </div>`;
  });
  document.getElementById('productList').innerHTML=html;
}

function renderOrders(){
  let html='';
  let today=0;
  let todayStr=new Date().toLocaleDateString();

  orders.forEach(o=>{
    if(o.date===todayStr) today+=o.total;
    html+=`
    <tr>
      <td>${o.date}</td>
      <td>${o.name}</td>
      <td>${o.product}</td>
      <td>${o.qty}</td>
      <td>${o.total}</td>
    </tr>`;
  });

  document.getElementById('orderTable').innerHTML=html;
  document.getElementById('todayIncome').innerText='Omzet Hari Ini: Rp '+today;
}

function renderChart(){
  let data={};
  orders.forEach(o=>{
    data[o.date]=(data[o.date]||0)+o.total;
  });

  let labels=Object.keys(data);
  let values=Object.values(data);

  if(chart) chart.destroy();

  chart=new Chart(document.getElementById('chart'),{
    type:'bar',
    data:{labels:labels,datasets:[{label:'Omzet',data:values}]}
  });
}

</script>document.getElementById('todayIncome').innerText='Omzet Hari Ini: Rp '+today;
}

function renderChart(){
let data={};
orders.forEach(o=>{data[o.date]=(data[o.date]||0)+o.total});
let labels=Object.keys(data);
let values=Object.values(data);
if(chart)chart.destroy();
chart=new Chart(document.getElementById('chart'),{
type:'bar',
data:{labels:labels,datasets:[{label:'Omzet',data:values}]}
});
}
</script>
</body>
</html>
