<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA7Ui4SXydisrIUpeX32vpqcIDQCsqOLXo",
  authDomain: "saayadonat.firebaseapp.com",
  databaseURL: "https://saayadonat-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "saayadonat",
  storageBucket: "saayadonat.firebasestorage.app",
  messagingSenderId: "191838417140",
  appId: "1:191838417140:web:7a41a9b5678e6200f2eea1"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let products = [];
let cart = [];

onValue(ref(db,'products'), snapshot=>{
  products = snapshot.val() || [];
  render();
});

function render(){
  let html='';
  products.forEach((p,i)=>{
    if(p.stock>0){
      html+=`
      <div class="product">
        <b>${p.name}</b><br>
        Rp ${p.price}<br>
        <span class="badge">Stok ${p.stock}</span><br>
        <button onclick="addCart(${i})">Tambah</button>
      </div>`;
    }else{
      html+=`
      <div class="product">
        <b>${p.name}</b><br>
        <span class="badge">Stok Habis</span>
      </div>`;
    }
  });
  document.getElementById('productList').innerHTML=html;
}

window.addCart = function(i){
  cart.push({index:i,qty:1});
  alert('Ditambahkan ke keranjang');
}

window.checkout = function(){
  if(cart.length===0) return alert('Keranjang kosong');

  let total=0;

  cart.forEach(c=>{
    let p=products[c.index];

    if(p.stock < c.qty){
      alert('Stok tidak cukup!');
      return;
    }

    p.stock -= c.qty;
    total += p.price*c.qty;

    push(ref(db,'orders'),{
      date:new Date().toLocaleDateString(),
      name:bName.value,
      product:p.name,
      qty:c.qty,
      total:p.price*c.qty
    });
  });

  set(ref(db,'products'), products);

  cart=[];
  alert('Pesanan berhasil ❤️');
}

</script>
</div>

<script>
let products=JSON.parse(localStorage.getItem('products')||'[]');
let cart=[];

function render(){
let html='';
products.forEach((p,i)=>{
if(p.stock>0){
html+=`
<div class="product">
<b>${p.name}</b><br>
Rp ${p.price}<br>
<span class="badge">Stok ${p.stock}</span><br>
<button onclick="addCart(${i})">Tambah</button>
</div>`;
}
});
document.getElementById('productList').innerHTML=html;
renderCart();
}

function addCart(i){
let existing=cart.find(c=>c.index===i);
if(existing){ existing.qty++; }
else{ cart.push({index:i,qty:1}); }
renderCart();
}

function removeCart(i){
cart.splice(i,1);
renderCart();
}

function renderCart(){
let html='';
let total=0;

cart.forEach((c,i)=>{
let p=products[c.index];
let subtotal=p.price*c.qty;
total+=subtotal;

html+=`
<div class="cart-item">
${p.name} (${c.qty}) - Rp ${subtotal}
<button onclick="removeCart(${i})">Hapus</button>
</div>`;
});

document.getElementById('cartList').innerHTML=html||'Keranjang kosong';
document.getElementById('totalPrice').innerText=total;
}

function toggleRekening(){
let metode=bMethod.value;
document.getElementById('rekeningBox').style.display=
metode==="Transfer"?"block":"none";
}

function checkout(){
if(cart.length===0)return alert('Keranjang kosong');

let name=bName.value;
let phone=bPhone.value;
let address=bAddress.value;
let method=bMethod.value;

if(!name || !phone || !address){
return alert('Lengkapi data terlebih dahulu');
}

let total=0;
let pesan=`Halo, saya ingin pesan:%0A%0A`;

cart.forEach(c=>{
let p=products[c.index];
let subtotal=p.price*c.qty;
total+=subtotal;
pesan+=`${p.name} (${c.qty}) - Rp ${subtotal}%0A`;
});

pesan+=`%0ATotal: Rp ${total}%0A`;
pesan+=`%0ANama: ${name}%0A`;
pesan+=`No WA: ${phone}%0A`;
pesan+=`Alamat: ${address}%0A`;
pesan+=`Metode: ${method}%0A`;

if(method==="Transfer"){
pesan+=`%0ASaya akan transfer ke rekening yang tertera dan kirim bukti pembayaran.`;
}

let noWA="6287789130676"; // GANTI NOMOR WA KAMU
window.open(`https://wa.me/${noWA}?text=${pesan}`,'_blank');

cart=[];
renderCart();
}

render();
</script>

</body>
</html>
